<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gridiron Runner</title>
<style>
  :root{
    --ground-h: 10px;                /* Turf thickness */
    --game-w: 840px;
    --game-h: 260px;
    --fg: #e2e8f0;
    --turf: #065f46;                 /* deep green */
    --turf-2: #047857;               /* lighter stripe */
    --hash: #e5e7eb;                 /* yard hashes */
    --padding-red: #ef4444;          /* tackling pad color */
    --padding-dark: #991b1b;
    --helmet: #1f2937;               /* player helmet */
    --jersey: #2563eb;               /* player jersey */
    --pants: #f59e0b;                /* player pants */
    --skin: #fbbf24;                 /* accent */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;display:grid;place-items:center;overflow:hidden;
    background:linear-gradient(180deg,#0b1220,#0f172a 40%,#111827);
    color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }
  .wrap{width:min(96vw,var(--game-w));}
  .topbar{display:flex;align-items:center;gap:12px;margin:10px 0 8px}
  .title{font-weight:700}
  .spacer{flex:1}
  .namebox{display:flex;gap:8px;align-items:center}
  .input{
    background:#0b1220;border:1px solid #334155;border-radius:10px;
    padding:.45rem .6rem;color:var(--fg);min-width:160px;outline:none;
  }
  .btn{background:#1f2937;color:var(--fg);border:1px solid #334155;padding:.5rem .75rem;border-radius:999px;cursor:pointer;font-weight:600}
  .btn:active{transform:scale(.98)}

  .main{display:grid;grid-template-columns: 1fr 220px; gap:10px}

  /* Game screen + layered skies for crossfade */
  .screen{
    position:relative;height:var(--game-h);border-radius:16px;overflow:hidden;border:1px solid #334155;
    background:#0000;
  }
  .sky{position:absolute;inset:0;transition:opacity 1800ms linear;opacity:0}
  .sky.visible{opacity:1}

  /* Stadium themes (0‚Üí9)
     Day ‚Üí Overcast ‚Üí Late Afternoon ‚Üí Dusk ‚Üí Night ‚Üí PrimeTime ‚Üí Playoffs ‚Üí Snow Game ‚Üí Color Rush ‚Üí Super Bowl Night */
  .theme-0{background:linear-gradient(180deg,#a7f3d0 0%,#34d399 40%,#0ea5e9 100%);}          /* day */
  .theme-1{background:linear-gradient(180deg,#cbd5e1 0%,#94a3b8 60%,#334155 100%);}          /* overcast */
  .theme-2{background:linear-gradient(180deg,#fde68a 0%,#fb923c 45%,#ef4444 100%);}          /* late afternoon */
  .theme-3{background:linear-gradient(180deg,#f472b6 0%,#a78bfa 45%,#312e81 100%);}          /* dusk */
  .theme-4{background:linear-gradient(180deg,#1e293b 0%,#0f172a 60%,#000 100%);}             /* night */
  .theme-5{background:radial-gradient(100% 90% at 50% 0%,#22d3ee 0%,#7c3aed 60%,#0f172a 100%);} /* primetime neon */
  .theme-6{background:linear-gradient(180deg,#eab308 0%,#ef4444 50%,#1d4ed8 100%);}          /* playoffs drama */
  .theme-7{background:linear-gradient(180deg,#e5e7eb 0%,#cbd5e1 40%,#64748b 100%);}          /* snow */
  .theme-8{background:linear-gradient(180deg,#0ea5e9 0%,#a78bfa 35%,#ef4444 70%,#0f172a 100%);}/* color rush */
  .theme-9{background:radial-gradient(80% 120% at 50% 10%,#7dd3fc22 0%,#312e81 50%,#111827 80%,#000 100%);}/* super bowl night */

  .hud{position:absolute;left:12px;top:10px;display:flex;gap:14px;font-variant-numeric:tabular-nums;z-index:6}
  .label{opacity:.95}

  /* TURF */
  .ground{position:absolute;left:0;right:0;bottom:0;height:var(--ground-h);
    background:repeating-linear-gradient(90deg,var(--turf) 0 24px,var(--turf-2) 24px 48px);
    box-shadow:0 -1px 0 #064e3b inset;z-index:6}
  .lane{position:absolute;left:0;right:0;bottom:calc(var(--ground-h));height:100%;pointer-events:none}
  /* Yard hashes & sideline */
  .lane:before{content:"";position:absolute;left:0;right:0;bottom:calc(var(--ground-h)+2px);height:100%;
    background:repeating-linear-gradient(90deg,transparent 0 38px,var(--hash) 38px 40px,transparent 40px 78px,var(--hash) 78px 80px);
    opacity:.22}
  .lane:after{content:"";position:absolute;left:0;right:0;bottom:calc(var(--ground-h)+1px);height:4px;background:#93c5fd22}

  .player{--size:62px;position:absolute;left:48px;bottom:var(--ground-h);width:var(--size);height:var(--size);display:grid;place-items:center;filter:drop-shadow(0 3px 0 rgba(0,0,0,.25));z-index:7}
  .sprite{width:100%;height:100%}
  .sprite svg{width:100%;height:100%}
  .player.dead{transform:rotate(-12deg)}

  /* Running animations */
  @keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(1.4px)} }
  @keyframes legA { 0%{transform:rotate(18deg)} 50%{transform:rotate(-18deg)} 100%{transform:rotate(18deg)} }
  @keyframes legB { 0%{transform:rotate(-18deg)} 50%{transform:rotate(18deg)} 100%{transform:rotate(-18deg)} }
  @keyframes armA { 0%{transform:rotate(22deg)} 50%{transform:rotate(-14deg)} 100%{transform:rotate(22deg)} }
  @keyframes armB { 0%{transform:rotate(-10deg)} 50%{transform:rotate(16deg)} 100%{transform:rotate(-10deg)} }
  .run .p-body{animation:bob .26s linear infinite}
  .run .leg-a{transform-origin:6px 4px;animation:legA .22s linear infinite}
  .run .leg-b{transform-origin:6px 4px;animation:legB .22s linear infinite}
  .run .arm-a{transform-origin:5px 5px;animation:armA .22s linear infinite}
  .run .arm-b{transform-origin:5px 5px;animation:armB .22s linear infinite}
  .leg-a,.leg-b,.arm-a,.arm-b,.p-body{animation-play-state:paused}

  /* Obstacles ‚Üí tackling pads / defenders */
  .obstacle{
    --w:20px;--h:44px;position:absolute;bottom:var(--ground-h);width:var(--w);height:var(--h);
    background:linear-gradient(180deg,var(--padding-red),#fb7185);border:1px solid var(--padding-dark);border-bottom-color:#7f1d1d;border-radius:6px 6px 4px 4px;
    box-shadow:0 3px 0 rgba(0,0,0,.25);will-change: transform; contain: content; z-index:7;
  }
  .obstacle:after{content:"";position:absolute;left:2px;right:2px;top:4px;height:6px;border-radius:3px;background:#0003}

  /* Stadium lights (replaces clouds) */
  .lights{position:absolute;top:10px;width:70px;height:22px;z-index:5;will-change: transform; contain: content}
  .lights .mast{position:absolute;left:32px;top:0;width:6px;height:26px;background:#94a3b8;border-radius:2px}
  .lights .bank{position:absolute;top:-4px;left:10px;width:50px;height:14px;background:#cbd5e166;border-radius:8px;box-shadow:0 0 12px #e5e7ebb3 inset,0 2px 4px rgba(0,0,0,.2)}

  .overlay{position:absolute;inset:0;display:grid;place-items:center;background:linear-gradient(#0000,#0002);text-align:center;padding:24px;z-index:8}
  .card{background:#0b1220cc;border:1px solid #334155;border-radius:14px;padding:18px 20px;max-width:520px}
  .card h2{margin:0 0 10px;font-size:20px}
  .card p{margin:6px 0;opacity:.95}
  .kbd{background:#111827;border:1px solid #374151;padding:.15rem .45rem;border-radius:6px}
  .startRow{display:flex;gap:10px;justify-content:center;margin-top:10px}

  .board{height:var(--game-h);border:1px solid #334155;border-radius:16px;padding:10px 12px;overflow:auto;background:#0b1220cc}
  .board h3{margin:0 0 8px;font-size:15px}
  .board ol{margin:0;padding-left:18px}
  .board li{margin:6px 0;font-variant-numeric:tabular-nums}

  @media (max-width:860px){.main{grid-template-columns:1fr}.board{height:auto}}
</style>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <div class="title">üèà Gridiron Runner</div>
    <div class="spacer"></div>
    <div class="namebox">
      <label for="playerName">Name</label>
      <input id="playerName" class="input" maxlength="12" placeholder="Player" />
      <button id="restartBtn" class="btn" aria-label="Restart (R)">Restart</button>
    </div>
  </div>

  <div class="main">
    <div class="screen" id="screen" role="region" aria-label="Gridiron Runner game area">
      <div id="skyA" class="sky theme-0 visible" aria-hidden="true"></div>
      <div id="skyB" class="sky theme-0" aria-hidden="true"></div>

      <div class="hud">
        <div class="label">Yards: <span id="score">00000</span></div>
        <div class="label">Record: <span id="best">00000</span></div>
        <div class="label">Speed: <span id="speed">1.00x</span></div>
      </div>

      <div class="lane"></div>
      <div id="lights"></div>

      <div class="player" id="player" aria-label="running back">
        <div class="sprite" id="sprite" aria-hidden="true">
          <!-- Simple running back (SVG) -->
          <svg viewBox="0 0 72 52" xmlns="http://www.w3.org/2000/svg">
            <g class="p-body">
              <!-- Helmet -->
              <ellipse cx="48" cy="16" rx="10" ry="8" fill="var(--helmet)" stroke="#111827" stroke-width="1"/>
              <rect x="51" y="15" width="6" height="4" rx="1" fill="#e5e7eb"/>
              <!-- Jersey -->
              <path d="M18,32 q8,-12 24,-10 q12,2 13,12 q1,10 -13,12 q-20,3 -24,-6 q-3,-6 0,-8 z" fill="var(--jersey)" stroke="#0b1220" stroke-width="1"/>
              <!-- Ball tucked -->
              <ellipse cx="42" cy="28" rx="6.5" ry="4" fill="#8b5a2b" stroke="#4b2e12" stroke-width=".8"/>
              <path d="M36 28 h12" stroke="#fef3c7" stroke-width="1"/>
              <!-- Legs -->
              <g transform="translate(24,36)">
                <g transform="translate(-2,0)">
                  <rect class="leg-a" x="0" y="0" width="7" height="12" rx="3" fill="var(--pants)" stroke="#78350f" stroke-width=".8"/>
                  <rect class="leg-b" x="10" y="0" width="7" height="12" rx="3" fill="var(--pants)" stroke="#78350f" stroke-width=".8"/>
                </g>
                <g transform="translate(18,0)">
                  <rect class="leg-b" x="0" y="0" width="7" height="12" rx="3" fill="var(--pants)" stroke="#78350f" stroke-width=".8"/>
                  <rect class="leg-a" x="10" y="0" width="7" height="12" rx="3" fill="var(--pants)" stroke="#78350f" stroke-width=".8"/>
                </g>
              </g>
              <!-- Arms -->
              <g transform="translate(28,24)">
                <rect class="arm-a" x="-4" y="-2" width="7" height="8" rx="3" fill="#e5e7eb" stroke="#334155" stroke-width=".8"/>
              </g>
              <g transform="translate(42,24)">
                <rect class="arm-b" x="-2" y="-2" width="7" height="8" rx="3" fill="#e5e7eb" stroke="#334155" stroke-width=".8"/>
              </g>
            </g>
          </svg>
        </div>
      </div>

      <div class="ground"></div>

      <!-- Start/help overlay -->
      <div class="overlay" id="help" aria-live="polite">
        <div class="card">
          <h2>Hurdle pads, rack up yards üèÉ‚Äç‚ôÇÔ∏èüí®</h2>
          <p>
          Type your name, then press <span class="kbd">Space</span> to <strong>start</strong> and jump.<br>
          <strong>Hold</strong> Space for higher/long jumps, or tap for quick hops ‚Äî jump height depends on how long you press.<br>
          (Tap/click only jumps after the run has started.)
          </p>
          <div class="startRow" style="justify-content:center;gap:8px;margin-top:12px">
            <label for="startName">Name</label>
            <input id="startName" class="input" maxlength="12" placeholder="Player" />
          </div>
        </div>
      </div>

      <div class="overlay" id="gameover" style="display:none">
        <div class="card">
          <h2>Drive Over üí•</h2>
          <p>Yards gained: <strong><span id="finalScore">0</span></strong></p>
          <p>Top 10 updates automatically if your run qualifies.</p>
          <p><button id="againBtn" class="btn">Run it back</button></p>
        </div>
      </div>
    </div>

    <aside class="board">
      <h3>üèÜ Leaderboard (Top 10)</h3>
      <ol id="topList"><li>Loading‚Ä¶</li></ol>
    </aside>
  </div>
</div>

<!-- Supabase client -->
<script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" defer></script>

<script>
(() => {
  "use strict";

  // ======== SUPABASE CONFIG ========
  const SUPABASE_URL = "https://svtihdbdlffwgymbzben.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2dGloZGJkbGZmd2d5bWJ6YmVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxMTI3MzcsImV4cCI6MjA3MDY4ODczN30.hO_fQVCYfSYNzTjVfbsxBfOs_zlNw3oGarxoUHwvAtA";
  // ==================================

  let supa = null;
  window.addEventListener("load", () => {
    try {
      supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      fetchTop();
    } catch (e) { console.warn("Supabase init failed", e); }
  });

  // ---------- DOM ----------
  const screen = document.getElementById("screen");
  const skyA = document.getElementById("skyA");
  const skyB = document.getElementById("skyB");
  let activeSky = "A";

  const playerEl = document.getElementById("player");
  const spriteEl = document.getElementById("sprite");
  const scoreEl  = document.getElementById("score");
  const bestEl   = document.getElementById("best");
  const speedEl  = document.getElementById("speed");
  const overEl   = document.getElementById("gameover");
  const helpEl   = document.getElementById("help");
  const restartBtn = document.getElementById("restartBtn");
  const againBtn = document.getElementById("againBtn");

  const nameTop = document.getElementById("playerName");
  const nameStart = document.getElementById("startName");
  const topList = document.getElementById("topList");

  // ---------- Name persistence + sync ----------
  const getStoredName = () => localStorage.getItem("gridiron-name") || "Player";
  const setStoredName = (v) => localStorage.setItem("gridiron-name", (v || "Player").slice(0,12));
  const getNameOrDefault = () => {
    const v = (nameTop.value || nameStart.value || "").trim();
    return v || "Player";
  };

  const initialName = getStoredName();
  nameTop.value = initialName;
  nameStart.value = initialName;

  nameTop.addEventListener("input", () => {
    nameStart.value = nameTop.value.slice(0,12);
    setStoredName(nameTop.value);
  });
  nameStart.addEventListener("input", () => {
    nameTop.value = nameStart.value.slice(0,12);
    setStoredName(nameStart.value);
  });

  // ---------- Game constants ----------
  const GROUND = parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--ground-h"));
  const GRAVITY = 2400;         // px/s^2
  const JUMP_KICK = 560;        // px/s
  const JUMP_HOLD_MS = 220;     // ms
  const JUMP_HOLD_BOOST = 1600; // px/s^2 while holding
  const BASE_SPEED = 380;       // px/s
  const MAX_SCALE = 2.6;        // speed cap

  // Background milestones (10 stages including 0)
  const BG_THRESHOLDS = [0, 50, 150, 300, 600, 1000, 1600, 2300, 3200, 4500]; // treat score as yards
  let currentTheme = 0;

  // ---------- State ----------
  let runner = { y: GROUND, vy: 0, jumps: 0, alive: true };
  let jumpPressed = false;
  let jumpStartAt = 0;
  let holdLatchUntil = 0;
  let obstacles = []; // {el,x,w,h}
  let lights = [];    // {el,x,v}
  let running = false;
  let started = false;
  let tPrev = 0;
  let tick = 0;
  let score = 0;      // yards
  let best = parseInt(localStorage.getItem("gridiron-best") || "0", 10);
  let speedScale = 1;
  let spawnTimerMs = 0;

  // Drift state for heavy-tailed randomness
  let driftMu = 0;
  let driftSigma = 0;

  function randn(){
    let u=0, v=0; while (u===0) u=Math.random(); while (v===0) v=Math.random();
    return Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v);
  }

  function isTyping(){
    const el = document.activeElement; if(!el) return false; const tag = el.tagName;
    return tag==='INPUT' || tag==='TEXTAREA' || el.isContentEditable;
  }

  bestEl.textContent = String(best).padStart(5, "0");
  applyTheme(0, true);

  const setTransformX = (el, x) => { el.style.transform = `translate3d(${x}px,0,0)`; };

  // ---------- Stadium lights ----------
  function ensureLights(){ while(lights.length < 4) addLight(true); }
  function addLight(init=false){
    const el = document.createElement("div");
    el.className = "lights";
    el.innerHTML = '<div class="mast"></div><div class="bank"></div>';
    const top = 10 + Math.random()*80;
    const x = init ? screen.clientWidth*Math.random() : screen.clientWidth + Math.random()*120;
    el.style.top = top + "px";
    screen.appendChild(el);
    const c = { el, x, v: 26 + Math.random()*36 };
    setTransformX(el, x); lights.push(c);
  }

  // ---------- Obstacles ----------
  function addObstacle(){
    const el = document.createElement("div"); el.className = "obstacle";
    const tall = Math.random() < 0.42;
    const w = (tall ? 24 : 20) + Math.floor(Math.random()*3);
    const h = tall ? 56 : 40;
    el.style.width = w + "px"; el.style.height = h + "px";
    screen.appendChild(el);
    const o = { el, x: screen.clientWidth, w, h }; setTransformX(el, o.x); obstacles.push(o);

    // Siblings with slight spacing wobble
    const baseSibling = Math.max(3, 8 - Math.floor(3 * (speedScale - 1)));
    const siblingGapPx = Math.max(2, Math.round(baseSibling + (Math.random()*6 - 3)));
    const wantDouble = Math.random() < 0.35; const wantTriple = wantDouble && Math.random() < 0.15;
    let tail = o;
    function makeSiblingAfter(prev){
      const el2 = document.createElement("div"); el2.className = "obstacle";
      const w2 = (Math.random() < 0.55 ? 20 : 24);
      const h2 = Math.random() < 0.5 ? 40 : 54;
      el2.style.width = w2 + "px"; el2.style.height = h2 + "px";
      const x2 = prev.x + prev.w + siblingGapPx;
      const o2 = { el: el2, x: x2, w: w2, h: h2 }; setTransformX(el2, o2.x); screen.appendChild(el2); obstacles.push(o2); return o2;
    }
    if (wantDouble)  tail = makeSiblingAfter(tail);
    if (wantTriple)  tail = makeSiblingAfter(tail);
  }

  // ---------- Start & Jump ----------
  function startGame(){ if(started) return; started = true; setStoredName(getNameOrDefault()); helpEl.style.display = "none"; start(); }
  function startJump(){ if(!running) return; if(runner.jumps >= 1) return; runner.vy = JUMP_KICK; runner.jumps++; jumpPressed = true; jumpStartAt = performance.now(); holdLatchUntil = jumpStartAt + 45; }
  function endJump(){ jumpPressed = false; }

  // ---------- Hitboxes ----------
  function deflateRect(r, pad){ return { left:r.left+(pad.left||0), right:r.right-(pad.right||0), top:r.top+(pad.top||0), bottom:r.bottom-(pad.bottom||0) }; }
  function overlap(a,b){ return !(a.right < b.left || a.left > b.right || a.bottom < b.top || a.top > b.bottom); }
  const P_PAD = { left:12, right:16, top:8, bottom:2 };
  const O_PAD = { left:2, right:2, top:4, bottom:0 };

  // ---------- Main loop ----------
  function loop(ts){
    try{
      if(!running) return; if(!tPrev) tPrev = ts; const dt = Math.min(50, ts - tPrev); const dtSec = dt/1000; tPrev = ts;
      tick++;

      // Speed ramp
      speedScale = Math.min(MAX_SCALE, 1 + 1.35 * (1 - Math.exp(-score / 4500)));
      speedEl.textContent = speedScale.toFixed(2) + "x";

      // Lights move
      for(let i=lights.length-1;i>=0;i--){
        const c = lights[i]; c.x -= c.v * dtSec * (0.7 + 0.6*(speedScale-1)); setTransformX(c.el, c.x);
        if(c.x < -90){ c.el.remove(); lights.splice(i,1); addLight(false); }
      }

      // ----- Spawns -----
      if (spawnTimerMs <= 0) {
        addObstacle();
        const worldPxPerSec = BASE_SPEED * Math.max(1, speedScale);
        const minWorldGapPx = 240 + Math.max(0, 120 - score / 4) + 90 * (speedScale - 1);
        const minMs = Math.ceil((minWorldGapPx / worldPxPerSec) * 1000);
        driftMu = 0.92*driftMu + 0.08*randn(); driftSigma = 0.85*driftSigma + 0.15*randn();
        let medianExtraPx = (Math.random()<0.55?120:300) + 60*(speedScale-1); medianExtraPx *= (1 + 0.35*Math.tanh(driftMu));
        let sigmaLN = 1.0 + 0.35*(speedScale-1) + 0.35*Math.tanh(driftSigma); sigmaLN = Math.max(0.8, Math.min(1.7, sigmaLN));
        const muLN = Math.log(Math.max(1, medianExtraPx)); const extraPx = Math.exp(muLN + sigmaLN * randn());
        let burstClampPx = Infinity; if (Math.random() < 0.22) burstClampPx = 80 + 90 * Math.random();
        const gapWorldPx = minWorldGapPx + Math.min(extraPx, burstClampPx);
        let sampleMs = Math.round((gapWorldPx / worldPxPerSec) * 1000);
        const maxMs = Math.min(1100, Math.ceil(((minWorldGapPx + 700) / worldPxPerSec) * 1000));
        if (!Number.isFinite(sampleMs)) sampleMs = minMs + 120; spawnTimerMs = Math.max(minMs + 30, Math.min(maxMs, sampleMs));
      }
      spawnTimerMs -= dt; if (!Number.isFinite(spawnTimerMs)) spawnTimerMs = 300; if (spawnTimerMs < -300) spawnTimerMs = -300; if (obstacles.length === 0 && spawnTimerMs > 1200) spawnTimerMs = 120;

      // Move obstacles & collisions
      const px = BASE_SPEED * speedScale * dtSec;
      const runnerRect = deflateRect(playerEl.getBoundingClientRect(), P_PAD);
      for(let i=obstacles.length-1;i>=0;i--){
        const o = obstacles[i]; o.x -= px; setTransformX(o.el, o.x);
        const r = deflateRect(o.el.getBoundingClientRect(), O_PAD);
        if(overlap(runnerRect, r)){ endGame(); break; }
        if(o.x < -o.w - 12){ o.el.remove(); obstacles.splice(i,1); }
      }

      // Physics
      let ay = -GRAVITY;
      const now = performance.now();
      if ((jumpPressed || now < holdLatchUntil) && (now - jumpStartAt) < JUMP_HOLD_MS && runner.vy > 0) { ay += JUMP_HOLD_BOOST; }
      runner.vy += ay * dtSec; runner.y = Math.max(GROUND, runner.y + runner.vy * dtSec);
      if(runner.y === GROUND){ runner.vy = 0; runner.jumps = 0; spriteEl.classList.add("run"); } else { spriteEl.classList.remove("run"); }
      playerEl.style.bottom = runner.y + "px";

      // Score
      score += Math.max(1, Math.floor(1.2 * speedScale));
      if(score > best){ best = score; localStorage.setItem("gridiron-best", String(best)); bestEl.textContent = String(best).padStart(5,"0"); }
      scoreEl.textContent = String(score).padStart(5,"0");

      updateBackground(score);
    } catch(err){ console.error("Game loop error:", err); }
    if(running) requestAnimationFrame(loop);
  }

  // ---------- Lifecycle ----------
  function start(){
    obstacles.forEach(o=>o.el.remove()); obstacles=[];
    lights.forEach(c=>c.el.remove()); lights=[];
    score=0; tick=0; speedScale=1; spawnTimerMs=300; driftMu=0; driftSigma=0;
    runner = { y: GROUND, vy: 0, jumps: 0, alive: true };
    playerEl.style.bottom = GROUND + "px"; playerEl.classList.remove("dead"); spriteEl.classList.remove("run");
    ensureLights(); applyTheme(0, true);
    running = true; requestAnimationFrame(loop);
  }
  function endGame(){ running = false; runner.alive = false; playerEl.classList.add("dead"); document.getElementById("finalScore").textContent = String(score); overEl.style.display=""; submitScore(getNameOrDefault(), score).catch(()=>{}); }
  function restart(){ overEl.style.display="none"; tPrev=0; start(); }

  // ---------- Input ----------
  window.addEventListener("keydown", (e) => {
    if (isTyping()) return; if (e.code === "Space") { e.preventDefault(); if (!started) { setStoredName(getNameOrDefault()); startGame(); startJump(); } else { startJump(); } } else if (e.code === "KeyR") { e.preventDefault(); restart(); }
  }, { passive:false });
  window.addEventListener("keyup", (e)=> { if (isTyping()) return; if(e.code === "Space"){ endJump(); } });
  screen.addEventListener("pointerdown", () => { if (started) startJump(); }, { passive:true });
  window.addEventListener("pointerup", () => endJump(), { passive:true });
  restartBtn.addEventListener("click", () => { started=true; restart(); });
  if (againBtn) againBtn.addEventListener("click", () => { started=true; restart(); });

  // ---------- Leaderboard ----------
  async function submitScore(name, score){
    try {
      if (!supa) { supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); }
      name = (name || "Player").slice(0,12).replace(/[<>]/g,'');
      const { error } = await supa.from("scores").insert({ name, score }); if (error) throw error; await fetchTop();
    } catch (e) { console.warn("submitScore failed", e); if (topList) topList.innerHTML = '<li>(leaderboard error ‚Äî check RLS policies on "scores")</li>'; }
  }
  async function fetchTop(){ if (!supa || !topList) return; try { const { data, error } = await supa.from("scores").select("name,score").order("score", { ascending:false }).limit(10); if (error) throw error; renderTop(data || []);} catch(e){ topList.innerHTML = "<li>(leaderboard unavailable)</li>"; } }
  function renderTop(rows){ if(!rows.length){ topList.innerHTML = "<li>No scores yet ‚Äî be first!</li>"; return; } topList.innerHTML = rows.map((r)=>(`<li><strong>${escapeHtml(r.name||"Player")}</strong> ‚Äî ${r.score}</li>`)).join(""); }
  function escapeHtml(s){ return s.replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  // ---------- Background crossfade ----------
  function updateBackground(scoreVal){ let idx = 0; for (let i = BG_THRESHOLDS.length - 1; i >= 0; i--) { if (scoreVal >= BG_THRESHOLDS[i]) { idx = i; break; } } if (idx !== currentTheme){ applyTheme(idx); } }
  function applyTheme(idx, immediate=false){ currentTheme = idx; const showEl = (activeSky === "A") ? skyB : skyA; const hideEl = (activeSky === "A") ? skyA : skyB; showEl.className = `sky theme-${idx}` + (immediate ? " visible" : ""); if (immediate){ hideEl.classList.remove("visible"); activeSky = (activeSky === "A") ? "B" : "A"; return; } void showEl.offsetWidth; hideEl.classList.remove("visible"); showEl.classList.add("visible"); activeSky = (activeSky === "A") ? "B" : "A"; }
})();
</script>
</body>
</html>
